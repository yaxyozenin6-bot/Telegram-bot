import telebot
from telebot import types
import json
import os
import random
import re
import time

# To'g'ridan-to'g'ri token va admin ID ni shu yerga yozing
TOKEN = "8247262403:AAF_nATMQdTUTjIJa2RX3w9jcqV4IU8L1L4"
ADMIN_ID = 7569090252

bot = telebot.TeleBot(TOKEN)
DATA_FILE = 'videos.json'

search_mode = {}
user_recommendations = {}

blocked_users = set()  # Bloklangan foydalanuvchilar

# Matnni tekshirish uchun funktsiya (faqat harflar, raqamlar, probel va ba'zi belgilar)
def is_valid_text(text):
    return bool(re.match(r'^[\w\s\-.,!?]+$', text))

def load_data():
    if not os.path.exists(DATA_FILE):
        return []
    with open(DATA_FILE, 'r', encoding='utf-8') as f:
        return json.load(f)

def save_data(data):
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

# Bloklangan foydalanuvchilar uchun javob
@bot.message_handler(func=lambda message: message.from_user.id in blocked_users)
def blocked_user_handler(message):
    bot.reply_to(message, "âŒ Siz bloklangansiz va botdan foydalanish imkoniyatingiz yoâ€˜q.")

# /start komandasi
@bot.message_handler(commands=['start'])
def send_welcome(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add(types.KeyboardButton("ğŸ” Anime izlash"))
    markup.add(types.KeyboardButton("ğŸ Konkurs"), types.KeyboardButton("ğŸ“¢ Eâ€™lonlar"))
    markup.add(types.KeyboardButton("ğŸ“— Qoâ€˜llanma"), types.KeyboardButton("ğŸ’¼ Reklama va Homiylik"))
    bot.send_message(message.chat.id,
                     "Assalomu alaykum! Quyidagi boâ€˜limlardan birini tanlang:",
                     reply_markup=markup)

# ğŸ” Anime izlash
@bot.message_handler(func=lambda message: message.text == "ğŸ” Anime izlash")
def handle_anime(message):
    bot.send_message(message.chat.id, "Qaysi anime kerak? Ismini yozing...")
    search_mode[message.chat.id] = True

# ğŸ Konkurs
@bot.message_handler(func=lambda message: message.text == "ğŸ Konkurs")
def handle_konkurs(message):
    bot.send_message(message.chat.id, "Hozircha aktiv konkurslar yoâ€˜q.")

# ğŸ“¢ Eâ€™lonlar
@bot.message_handler(func=lambda message: message.text == "ğŸ“¢ Eâ€™lonlar")
def handle_elon(message):
    bot.send_message(message.chat.id, "Soâ€˜nggi eâ€™lonlar: hech narsa yo'q.")

# ğŸ“— Qoâ€˜llanma
@bot.message_handler(func=lambda message: message.text == "ğŸ“— Qoâ€˜llanma")
def handle_qollanma(message):
    bot.send_message(message.chat.id, "Botdan foydalanish boâ€˜yicha qoâ€˜llanma...")

# ğŸ’¼ Reklama va Homiylik
@bot.message_handler(func=lambda message: message.text == "ğŸ’¼ Reklama va Homiylik")
def handle_reklama(message):
    bot.send_message(message.chat.id, "Reklama uchun @psixo_666 bilan bogâ€˜laning.")

# âš™ï¸ /admin komandasi
@bot.message_handler(commands=['admin'])
def handle_admin(message):
    bot.reply_to(message, "ğŸ›  Admin bilan bogâ€˜lanish uchun: @psixo_666")

# ğŸ†˜ /muammo komandasi
@bot.message_handler(commands=['muammo'])
def handle_muammo(message):
    bot.send_message(message.chat.id, "â— Iltimos, duch kelgan muammoingizni yozing:")
    bot.register_next_step_handler(message, process_muammo)

def process_muammo(message):
    text = message.text
    if not is_valid_text(text):
        bot.reply_to(message, "âš ï¸ Muammo matni notoâ€˜gâ€˜ri kiritildi. Iltimos, qayta urinib koâ€˜ring.")
        return
    user = message.from_user
    msg = f"ğŸ†˜ MUAMMO YUBORILDI\nğŸ‘¤ @{user.username or user.first_name} (ID: {user.id})\nğŸ“© Muammo: {text}"
    bot.send_message(ADMIN_ID, msg)
    bot.reply_to(message, "âœ… Muammoingiz yuborildi. Tez orada javob beramiz.")

# ğŸ’¡ /tavsiya komandasi
@bot.message_handler(commands=['tavsiya'])
def handle_tavsiya(message):
    bot.send_message(message.chat.id, "ğŸ’¡ Taklif yoki tavsiyangizni yozing:")
    bot.register_next_step_handler(message, process_tavsiya)

def process_tavsiya(message):
    text = message.text
    if not is_valid_text(text):
        bot.reply_to(message, "âš ï¸ Tavsiya matni notoâ€˜gâ€˜ri kiritildi. Iltimos, qayta urinib koâ€˜ring.")
        return
    user = message.from_user
    msg = f"ğŸ“¬ TAVSIYA YUBORILDI\nğŸ‘¤ @{user.username or user.first_name} (ID: {user.id})\nğŸ’¡ Tavsiya: {text}"
    bot.send_message(ADMIN_ID, msg)
    bot.reply_to(message, "âœ… Tavsiyangiz yuborildi. Rahmat!")

# ğŸ¥ Video yuklash (faqat admin)
@bot.message_handler(content_types=['video'])
def handle_video(message):
    if message.from_user.id != ADMIN_ID:
        bot.reply_to(message, "âŒ Sizda video yuklash uchun ruxsat yoâ€˜q.")
        return
    bot.send_message(message.chat.id, "ğŸ“Œ Videoga nom kiriting:")
    bot.register_next_step_handler(message, lambda msg: save_video_info(msg, message.video.file_id))

def save_video_info(message, file_id):
    title = message.text.strip().lower()
    if not is_valid_text(title):
        bot.send_message(message.chat.id, "âš ï¸ Notoâ€˜gâ€˜ri nom kiritildi. Iltimos, faqat harflar va raqamlar ishlating.")
        return

    data = load_data()
    if any(item['title'] == title for item in data):
        bot.send_message(message.chat.id, f"âš ï¸ '{title}' nomli video allaqachon saqlangan.")
        return

    data.append({
        "title": title,
        "file_id": file_id
    })
    save_data(data)
    bot.send_message(message.chat.id, f"âœ… '{title}' nomli video saqlandi!")

# ğŸ” Matn boâ€˜yicha izlash
@bot.message_handler(func=lambda message: True)
def handle_all_messages(message):
    if search_mode.get(message.chat.id):
        keyword = message.text.lower()
        data = load_data()
        results = [item for item in data if keyword in item['title']]
        if not results:
            if data:
                recommended = random.sample(data, min(3, len(data)))
                user_recommendations[message.chat.id] = recommended

                markup = types.InlineKeyboardMarkup()
                for idx, item in enumerate(recommended):
                    markup.add(types.InlineKeyboardButton(
                        text=item['title'].capitalize(),
                        callback_data=f"video_{idx}"
                    ))

                bot.send_message(
                    message.chat.id,
                    "âŒ Video topilmadi. Quyidagilardan tanlang:",
                    reply_markup=markup
                )
            else:
                bot.send_message(message.chat.id, "âŒ Hech qanday video topilmadi.")
        else:
            item = results[0]
            bot.send_video(message.chat.id, item['file_id'], caption=item['title'])

        search_mode[message.chat.id] = False
    else:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        markup.add(types.KeyboardButton("ğŸ” Anime izlash"))
        markup.add(types.KeyboardButton("ğŸ Konkurs"), types.KeyboardButton("ğŸ“¢ Eâ€™lonlar"))
        markup.add(types.KeyboardButton("ğŸ“— Qoâ€˜llanma"), types.KeyboardButton("ğŸ’¼ Reklama va Homiylik"))
        bot.send_message(
            message.chat.id,
            "â— Notoâ€˜gâ€˜ri buyruq yoki xabar. Iltimos, menyudan tanlang:",
            reply_markup=markup
        )

# â–¶ï¸ Inline video tanlash
@bot.callback_query_handler(func=lambda call: call.data.startswith("video_"))
def callback_video(call):
    try:
        idx = int(call.data.split('_')[1])
        video_item = user_recommendations.get(call.message.chat.id, [])[idx]
        bot.send_video(call.message.chat.id, video_item['file_id'], caption=video_item['title'])
        bot.edit_message_reply_markup(call.message.chat.id, call.message.message_id, reply_markup=None)
        user_recommendations.pop(call.message.chat.id, None)
        bot.answer_callback_query(call.id, text=f"'{video_item['title'].capitalize()}' video tanlandi.")
    except (IndexError, ValueError):
        bot.answer_callback_query(call.id, "Xato: video topilmadi yoki noto'g'ri tugma.", show_alert=True)

# Admin orqali foydalanuvchini bloklash komandasi (ixtiyoriy)
@bot.message_handler(commands=['block'])
def block_user(message):
    if message.from_user.id == ADMIN_ID:
        try:
            user_id = int(message.text.split()[1])
            blocked_users.add(user_id)
            bot.send_message(message.chat.id, f"âœ… {user_id} foydalanuvchi bloklandi.")
        except:
            bot.send_message(message.chat.id, "â— Iltimos, toâ€˜gâ€˜ri ID kiriting. Misol: /block 123456789")

# Botni qayta ishga tushirish bilan ishlatish
while True:
    try:
        bot.polling(none_stop=True)
    except Exception as e:
        print(f"Xatolik yuz berdi: {e}")
        time.sleep(15)

